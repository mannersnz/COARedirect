name: Deploy Azure Function

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      slot:
        description: "Optional deployment slot name"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create deployment package (zip)
        run: |
          zip -r functionapp.zip . \
            -x "node_modules/*" \
               ".git/*" \
               ".github/*" \
               "local.settings.json" \
               "*.md"

      - name: Zip Deploy to Kudu (publish profile)
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          set -euo pipefail
          # Extract host and credentials
          eval "$(python3 .github/scripts/parse_publish_profile.py)"
          echo "Using Kudu host: $KUDU_HOST"
          if [ -n "${{ github.event.inputs.slot }}" ]; then
            echo "Note: Slots require a slot-specific publish profile."
          fi
          # Perform zipdeploy
          curl -fSs -u "$KUDU_USER:$KUDU_PASS" \
               -X POST \
               -H "Content-Type: application/zip" \
               --data-binary @functionapp.zip \
               "https://$KUDU_HOST/api/zipdeploy?isAsync=true"

      - name: Warm up Function App
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          eval "$(python3 .github/scripts/parse_publish_profile.py)"
          APP_HOST="${KUDU_HOST/.scm./.}"
          curl -sS --max-time 10 "https://${APP_HOST}" || true
